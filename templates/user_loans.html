<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sách đang mượn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { primary: { 50:'#eef2ff', 100:'#e0e7ff', 500:'#6366f1', 600:'#4f46e5', 700:'#4338ca' } } } } }</script>
</head>
<body class="bg-gray-100 font-sans h-screen flex overflow-hidden">
    <aside class="w-72 bg-white border-r border-slate-200 hidden md:flex flex-col h-full shadow-sm z-20">
        <div class="p-6 flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-primary-600 to-secondary-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-primary-500/30"><i class="fas fa-book-open"></i></div>
            <div><h1 class="font-bold text-xl text-slate-800 tracking-tight">LibManager</h1><p class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">User Portal</p></div>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <a href="/" class="flex items-center gap-3 px-4 py-3.5 text-slate-600 rounded-r-xl border-l-4 border-transparent hover:bg-slate-50 transition"><i class="fas fa-search w-5"></i> Tìm & Mượn sách</a>
            <a href="/my-books" class="flex items-center gap-3 px-4 py-3.5 rounded-r-xl border-l-4 border-primary-600 bg-gradient-to-r from-primary-50 to-transparent text-primary-700 font-bold transition"><i class="fas fa-clock w-5"></i> Sách đang mượn</a>
            <a href="/profile" class="flex items-center gap-3 px-4 py-3.5 text-slate-600 rounded-r-xl border-l-4 border-transparent hover:bg-slate-50 transition"><i class="fas fa-id-card w-5"></i> Hồ sơ cá nhân</a>
        </nav>
        <div class="p-4 border-t border-slate-100">
             <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 text-red-500 hover:bg-red-50 rounded-xl transition font-medium text-sm"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-4 sticky top-0 z-10"><h2 class="text-xl font-bold text-slate-800">Quản lý Sách đang mượn</h2></header>
        <div class="flex-1 overflow-y-auto p-8 animate-slide-up">
            <div class="bg-white rounded-2xl shadow-sm border border-orange-100 overflow-hidden">
                <div class="p-6 border-b border-orange-100 bg-gradient-to-r from-orange-50/50 to-white flex justify-between items-center">
                    <h3 class="font-bold text-orange-900 text-lg flex items-center gap-2"><i class="fas fa-clock text-orange-500"></i> Danh sách mượn</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-orange-50/80 text-xs text-orange-700 uppercase font-bold tracking-wider">
                            <tr><th class="p-5">Thông tin sách</th><th class="p-5">Thời gian</th><th class="p-5 text-center">Trạng thái</th><th class="p-5 text-right">Tác vụ</th></tr>
                        </thead>
                        <tbody id="loan-list" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
                 <div id="empty-msg" class="hidden p-10 text-center text-slate-400 italic">Bạn chưa mượn cuốn sách nào.</div>
            </div>
        </div>
    </main>
    <script>
        loadLoans();
        async function loadLoans() {
            const res = await fetch('/api/user/my-loans');
            const loans = await res.json();
            if(loans.length === 0) { document.getElementById('empty-msg').classList.remove('hidden'); return; }
            document.getElementById('loan-list').innerHTML = loans.map(l => `
                <tr class="hover:bg-slate-50/50 transition group">
                    <td class="p-5">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-16 bg-indigo-50 rounded-lg shadow-sm flex items-center justify-center text-indigo-300"><i class="fas fa-book-open"></i></div>
                            <div>
                                <p class="font-bold text-slate-800 text-sm group-hover:text-primary-600 transition">${l.book_title}</p>
                                <p class="text-xs text-slate-500 font-mono mt-1">Mã: ${l.barcode}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-5"><p class="text-xs text-slate-500">Mượn: ${l.borrow_date_fmt}</p><p class="font-bold text-sm ${l.is_overdue?'text-red-500':'text-emerald-600'}">Hạn: ${l.due_date_fmt}</p></td>
                    <td class="p-5 text-center">
                        ${l.status === 'pending'
                          ? '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold">Chờ lấy sách</span>'
                          : (l.is_overdue ? '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-bold">Quá hạn</span>'
                                          : '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">Đang mượn</span>')}
                    </td>
                    <td class="p-5 text-right">
                        ${l.status === 'borrowing' && !l.is_overdue && l.renew_count < 1
                          ? `<button onclick="renewBook('${l._id}')" class="text-primary-600 bg-primary-50 px-4 py-2 rounded-lg text-sm font-bold hover:bg-primary-600 hover:text-white transition">Gia hạn</button>`
                          : (l.status === 'pending' ? '<span class="text-slate-400 text-xs italic">Vui lòng đến thư viện</span>' : '<span class="text-slate-300 text-xs font-bold cursor-not-allowed">Không thể GH</span>')}
                    </td>
                </tr>
            `).join('');
        }
        async function renewBook(id) { if(confirm('Gia hạn sách 7 ngày?')) { const r = await fetch('/api/user/renew', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({trans_id:id})}); alert((await r.json()).message); loadLoans(); } }
        async function logout() { await fetch('/api/logout', {method:'POST'}); window.location.href='/'; }
    </script>
</body>
</html>